<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Kuis Sains SMP & SMA dengan Email OTP Verifikasi</title>
  <style>
    /* Reset */
    * {
      box-sizing: border-box;
    }
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
      color: #f0f0f0;
      overflow: hidden;
      user-select: none;
    }
    #app {
      width: 350px;
      max-width: 100vw;
      height: 600px;
      max-height: 100vh;
      margin: auto;
      background: #1e2a47;
      border-radius: 16px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.6);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    /* Slide container */
    .slides {
      display: flex;
      width: 300%;
      height: 100%;
      transition: transform 0.5s ease;
      will-change: transform;
    }
    .slide {
      width: 350px;
      max-width: 100vw;
      padding: 20px 30px;
      height: 100%;
      flex-shrink: 0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }
    /* General headings */
    h1, h2 {
      margin: 0 0 15px 0;
      font-weight: 700;
      letter-spacing: 1.5px;
      text-align: center;
      user-select: text;
    }
    /* ----------- Slide 1 Signup/Login ----------- */
    .form-container {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 100%;
    }
    label {
      font-size: 0.9rem;
      margin-bottom: 4px;
      color: #cbd5e1;
    }
    input[type=text], input[type=password], input[type=email] {
      padding: 10px 14px;
      font-size: 1rem;
      border-radius: 12px;
      border: none;
      outline: none;
      background: #2a3b65;
      color: #f0f0f0;
      transition: background 0.3s ease;
      user-select: text;
    }
    input[type=text]:focus, input[type=password]:focus, input[type=email]:focus {
      background: #3b527d;
    }
    button {
      background: #0078d7;
      border: none;
      color: #fff;
      padding: 14px 24px;
      font-size: 1.1rem;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s ease;
      user-select: none;
      margin-top: 10px;
    }
    button:hover:not(:disabled) {
      background: #005fa3;
    }
    button:disabled {
      background: #555976;
      cursor: default;
    }
    small.error {
      color: #f44336;
      font-size: 0.85rem;
      min-height: 18px;
      margin-top: -6px;
      user-select: text;
    }
    .toggle-login {
      color: #80b3ff;
      cursor: pointer;
      text-align: center;
      margin-top: 12px;
      font-size: 0.95rem;
      user-select: none;
    }
    /* OTP verification section (hidden initially) */
    #otp-section {
      display: none;
      flex-direction: column;
      margin-top: 12px;
    }
    #otp-section label {
      margin-bottom: 4px;
      font-size: 0.9rem;
      color: #cbd5e1;
    }
    #otp-section input {
      margin-bottom: 8px;
    }
    /* ----------- Slide 2 Home / Dashboard / Leaderboard ----------- */
    #slide2-header {
      margin-bottom: 10px;
    }
    .welcome-text {
      font-size: 1.2rem;
      text-align: center;
      margin-bottom: 20px;
      user-select: text;
    }
    /* Dashboard panel */
    .dashboard {
      background: #2a3b65;
      border-radius: 12px;
      padding: 15px 20px;
      margin-bottom: 20px;
      flex-shrink: 0;
      user-select: text;
    }
    .dashboard strong {
      color: #80b3ff;
    }
    /* Leaderboard */
    .leaderboard {
      flex-grow: 1;
      overflow-y: auto;
      background: #2a3b65;
      border-radius: 12px;
      padding: 15px 20px;
    }
    .leaderboard h2 {
      text-align: center;
      margin-bottom: 15px;
    }
    .leaderboard-list {
      list-style: none;
      margin: 0;
      padding: 0;
      user-select: text;
    }
    .leaderboard-list li {
      display: flex;
      justify-content: space-between;
      font-size: 1rem;
      padding: 8px 0;
      border-bottom: 1px solid #375a9a;
    }
    .leaderboard-list li:last-child {
      border-bottom: none;
    }
    .leaderboard-list .rank {
      color: #80b3ff;
      width: 30px;
      flex-shrink: 0;
      user-select: none;
    }
    /* Slide 2 controls */
    #slide2-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    #slide2-buttons button {
      background: #0078d7;
      padding: 10px 26px;
      font-size: 1rem;
      border-radius: 12px;
      user-select: none;
      flex: 1;
      max-width: 140px;
    }
    #slide2-buttons button:hover {
      background: #005fa3;
    }
    /* ----------- Slide 3 Quiz (same as before but adapted) ----------- */
    .question-number {
      text-align: center;
      font-size: 0.9rem;
      opacity: 0.7;
      margin-bottom: 12px;
      user-select: none;
    }
    .question-text {
      font-size: 1.2rem;
      margin-bottom: 25px;
      line-height: 1.3;
      min-height: 70px;
      text-align: center;
      user-select: none;
    }
    .answers {
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex-grow: 1;
      user-select: none;
    }
    button.answer {
      background: #2a3b65;
      border: none;
      border-radius: 12px;
      padding: 12px 18px;
      font-size: 1rem;
      color: #f0f0f0;
      cursor: pointer;
      text-align: left;
      transition: background 0.3s ease;
      box-shadow: inset 0 0 0 rgba(255,255,255,0);
      user-select: none;
    }
    button.answer:hover {
      background: #3c559f;
    }
    button.answer.correct {
      background: #4CAF50;
      box-shadow: inset 0 0 10px #4caf50;
      color: #fff;
    }
    button.answer.incorrect {
      background: #f44336;
      box-shadow: inset 0 0 10px #f44336;
      color: #fff;
    }
    button.answer:disabled {
      cursor: default;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      user-select: none;
    }
    button#next-btn {
      background: #0078d7;
      border: none;
      color: #fff;
      padding: 12px 24px;
      font-size: 1rem;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s ease;
      user-select: none;
    }
    button#next-btn:disabled {
      background: #555976;
      cursor: default;
    }
    button#quit-btn {
      background: #d9534f;
      border: none;
      color: #fff;
      padding: 12px 24px;
      font-size: 1rem;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s ease;
      user-select: none;
    }
    button#quit-btn:hover {
      background: #c9302c;
    }
    .score-area {
      text-align: center;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      user-select: text;
    }
    .score-area h2 {
      font-size: 1.6rem;
      margin-bottom: 15px;
    }
    .score-area p {
      font-size: 1.1rem;
      margin: 5px 0;
    }
    button#restart-btn-quiz {
      background: #ff9800;
      border: none;
      color: #fff;
      padding: 12px 24px;
      font-size: 1rem;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s ease;
      user-select: none;
      margin-top: 20px;
    }
    button#restart-btn-quiz:hover {
      background: #e68900;
    }
    /* Scrollbar for leaderboard and quiz answers on small devices */
    .leaderboard,
    .answers {
      scrollbar-width: thin;
      scrollbar-color: #375a9a transparent;
    }
    .leaderboard::-webkit-scrollbar,
    .answers::-webkit-scrollbar {
      width: 8px;
    }
    .leaderboard::-webkit-scrollbar-thumb,
    .answers::-webkit-scrollbar-thumb {
      background-color: #375a9a;
      border-radius: 20px;
    }
    /* Responsive */
    @media (max-width: 400px) {
      #app {
        width: 95vw;
        height: 95vh;
        padding: 15px 20px;
      }
      .slide {
        width: 95vw;
      }
      .slides {
        width: 285vw;
      }
      button, input[type=text], input[type=password], input[type=email] {
        font-size: 1rem;
      }
    }
  </style>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>
  <div id="app" aria-label="Aplikasi kuis sains dengan pendaftaran OTP EmailJS dan Firebase Auth">
    <div class="slides" id="slides">

      <!-- Slide 1: Signup/Login -->
      <section class="slide" aria-label="Halaman pendaftaran dan login user">
        <h1>Daftar / Masuk Akun</h1>
        <div class="form-container" role="form" aria-live="polite">
          <form id="form-signup-login" novalidate>
            <div id="signup-fields">
              <label for="nickname">Nickname</label>
              <input type="text" id="nickname" name="nickname" autocomplete="nickname" maxlength="20" required placeholder="Contoh: SiswaCerdas" />
              <small id="nickname-error" class="error"></small>

              <label for="email">Email</label>
              <input type="email" id="email" name="email" autocomplete="email" required placeholder="email@contoh.com" />
              <small id="email-error" class="error"></small>
            </div>

            <label for="password">Password</label>
            <input type="password" id="password" name="password" autocomplete="new-password" required minlength="6" placeholder="Minimal 6 karakter" />
            <small id="password-error" class="error"></small>

            <button type="submit" id="submit-btn">Daftar Akun</button>
          </form>
          <!-- OTP verification -->
          <div id="otp-section" aria-label="Verifikasi kode OTP">
            <label for="otp-input">Masukkan Kode OTP</label>
            <input type="text" id="otp-input" maxlength="6" placeholder="6 digit kode OTP" autocomplete="one-time-code" />
            <small id="otp-error" class="error"></small>
            <button id="verify-otp-btn">Verifikasi OTP</button>
            <button id="cancel-otp-btn" style="margin-top:10px;background:#f44336;">Batal Verifikasi</button>
          </div>
          <div class="toggle-login" id="toggle-to-login" tabindex="0" role="button" aria-pressed="false">Sudah punya akun? Masuk di sini</div>
          <div class="toggle-login" id="toggle-to-signup" tabindex="0" role="button" aria-pressed="false" style="display:none;">Belum punya akun? Daftar di sini</div>
        </div>
      </section>

      <!-- Slide 2: Home / Dashboard / Leaderboard -->
      <section class="slide" aria-label="Dashboard user, home dan leaderboard">
        <h1 id="slide2-header">Selamat Datang!</h1>
        <div class="welcome-text" id="welcome-text"></div>

        <div class="dashboard" aria-label="Informasi akun user">
          <p><strong>Nickname:</strong> <span id="dash-nickname"></span></p>
          <p><strong>Email:</strong> <span id="dash-email"></span></p>
          <p><strong>Skor Tertinggi:</strong> <span id="dash-best-score"></span></p>
        </div>

        <div class="leaderboard" aria-label="Daftar leaderboard pengguna terbaik">
          <h2>Leaderboard Top 10</h2>
          <ul class="leaderboard-list" id="leaderboard-list" tabindex="0" aria-live="polite" aria-relevant="additions"></ul>
        </div>

        <div id="slide2-buttons">
          <button id="btn-start-quiz" aria-label="Mulai kuis">Mulai Kuis</button>
          <button id="btn-logout" aria-label="Keluar dari akun">Logout</button>
        </div>
      </section>

      <!-- Slide 3: Quiz -->
      <section class="slide" aria-label="Halaman kuis sains">
        <div class="question-number" id="question-number">Soal 1 / 40</div>
        <div class="question-text" id="question-text" tabindex="0">...</div>
        <div class="answers" id="answers" role="list" aria-label="Pilihan jawaban"></div>
        <div class="controls">
          <button id="quit-btn" aria-label="Batal kuis dan kembali ke dashboard">Batal</button>
          <button id="next-btn" disabled aria-label="Soal berikutnya">Soal Berikutnya</button>
        </div>
        <div class="score-area" id="score-area" style="display:none;">
          <h2>Skor Kamu</h2>
          <p id="score-text"></p>
          <button id="restart-btn-quiz" aria-label="Main lagi">Main Lagi</button>
        </div>
      </section>

    </div>
  </div>

<script>
  // Firebase config & init
  const firebaseConfig = {
    apiKey: "AIzaSyBx2jh7CQJETDU1emLqvYcCUXqgff1btD0",
    authDomain: "registrasiking.firebaseapp.com",
    databaseURL: "https://registrasiking-default-rtdb.firebaseio.com",
    projectId: "registrasiking",
    storageBucket: "registrasiking.firebasestorage.app",
    messagingSenderId: "1008927663868",
    appId: "1:1008927663868:web:c62a264a76b6d84fce9979",
    measurementId: "G-83G2KVC0N9"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // EmailJS init (replace with your user ID)
  emailjs.init('YOUR_EMAILJS_USERID');
  const emailJsServiceID = 'YOUR_EMAILJS_SERVICEID'; // Your EmailJS service ID
  const emailJsTemplateID = 'template_1n9mh6sblfHFeOa_y4hjwoMX';

  // Elements
  const slides = document.getElementById('slides');
  const form = document.getElementById('form-signup-login');
  const nicknameInput = document.getElementById('nickname');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const submitBtn = document.getElementById('submit-btn');
  const toggleToLogin = document.getElementById('toggle-to-login');
  const toggleToSignup = document.getElementById('toggle-to-signup');

  const nicknameError = document.getElementById('nickname-error');
  const emailError = document.getElementById('email-error');
  const passwordError = document.getElementById('password-error');

  const otpSection = document.getElementById('otp-section');
  const otpInput = document.getElementById('otp-input');
  const otpError = document.getElementById('otp-error');
  const verifyOtpBtn = document.getElementById('verify-otp-btn');
  const cancelOtpBtn = document.getElementById('cancel-otp-btn');

  const welcomeText = document.getElementById('welcome-text');
  const dashNickname = document.getElementById('dash-nickname');
  const dashEmail = document.getElementById('dash-email');
  const dashBestScore = document.getElementById('dash-best-score');
  const leaderboardList = document.getElementById('leaderboard-list');
  const btnStartQuiz = document.getElementById('btn-start-quiz');
  const btnLogout = document.getElementById('btn-logout');

  const questionNumberElem = document.getElementById("question-number");
  const questionTextElem = document.getElementById("question-text");
  const answersElem = document.getElementById("answers");
  const nextBtn = document.getElementById("next-btn");
  const quitBtn = document.getElementById("quit-btn");
  const scoreArea = document.getElementById("score-area");
  const scoreText = document.getElementById("score-text");
  const restartBtnQuiz = document.getElementById("restart-btn-quiz");

  let isLoginMode = false;
  let otpSent = false;
  let generatedOtp = null;
  let otpExpireTime = null;

  function showSlide(index) {
    slides.style.transform = `translateX(${-index * 350}px)`;
  }
  function clearErrors() {
    nicknameError.textContent = '';
    emailError.textContent = '';
    passwordError.textContent = '';
    otpError.textContent = '';
  }
  function validateNickname(nick) {
    return /^[a-zA-Z0-9_]{3,20}$/.test(nick);
  }
  function validateEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.toLowerCase());
  }
  function resetFormFields(){
    nicknameInput.disabled = false;
    emailInput.disabled = false;
    passwordInput.disabled = false;
    submitBtn.disabled = false;
    otpSection.style.display = 'none';
    otpInput.value = '';
    generatedOtp = null;
    otpExpireTime = null;
    otpSent = false;
  }
  toggleToLogin.addEventListener('click', () => {
    if (!isLoginMode) {
      isLoginMode = true;
      toggleToLogin.style.display = 'none';
      toggleToSignup.style.display = 'block';
      resetFormFields();
      submitBtn.textContent = 'Masuk';
      nicknameInput.parentElement.style.display = 'none';
      emailInput.parentElement.style.display = '';
    }
  });
  toggleToSignup.addEventListener('click', () => {
    if (isLoginMode) {
      isLoginMode = false;
      toggleToLogin.style.display = 'block';
      toggleToSignup.style.display = 'none';
      resetFormFields();
      submitBtn.textContent = 'Daftar Akun';
      nicknameInput.parentElement.style.display = '';
      emailInput.parentElement.style.display = '';
    }
  });

  // Generate 6 digit OTP
  function generateOtp(){
    return Math.floor(100000 + Math.random()*900000).toString();
  }

  // Send OTP using EmailJS
  async function sendOtp(email, otp) {
    try {
      await emailjs.send(emailJsServiceID, emailJsTemplateID, {
        user_email: email,
        otp_code: otp
      });
      return true;
    } catch(err) {
      console.error('EmailJS gagal mengirim OTP:', err);
      return false;
    }
  }

  // Form submit handler
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearErrors();

    if(otpSent){
      // Prevent submit if already OTP sent and user not verified yet
      otpError.textContent = 'Silakan verifikasi OTP terlebih dahulu.';
      return;
    }

    const nick = nicknameInput.value.trim();
    const email = emailInput.value.trim();
    const pass = passwordInput.value.trim();

    // Login mode
    if(isLoginMode){
      if(!email){
        emailError.textContent = 'Email harus diisi';
        return;
      }
      if(!validateEmail(email)){
        emailError.textContent = 'Format email tidak valid';
        return;
      }
      if(!pass){
        passwordError.textContent = 'Password harus diisi';
        return;
      }
      submitBtn.disabled = true;
      try{
        await auth.signInWithEmailAndPassword(email, pass);
        const user = auth.currentUser;
        await loadUserProfile(user.uid);
        showSlide(1);
      }catch(err){
        submitBtn.disabled = false;
        if(err.code === 'auth/user-not-found'){
          emailError.textContent = 'Email belum terdaftar';
        } else if(err.code === 'auth/wrong-password'){
          passwordError.textContent = 'Password salah';
        } else {
          emailError.textContent = 'Gagal masuk: ' + err.message;
        }
      }
      return;
    }

    // Signup mode
    if(!nick){
      nicknameError.textContent = 'Nickname harus diisi';
      return;
    }
    if(!validateNickname(nick)){
      nicknameError.textContent = 'Nickname harus 3-20 karakter dan alfanumerik/underscore';
      return;
    }
    if(!email){
      emailError.textContent = 'Email harus diisi';
      return;
    }
    if(!validateEmail(email)){
      emailError.textContent = 'Format email tidak valid';
      return;
    }
    if(!pass || pass.length < 6){
      passwordError.textContent = 'Password minimal 6 karakter';
      return;
    }

    // Disable fields & button before sending OTP
    nicknameInput.disabled = true;
    emailInput.disabled = true;
    passwordInput.disabled = true;
    submitBtn.disabled = true;

    // Generate OTP and send email
    generatedOtp = generateOtp();
    otpSendDatetime = new Date();
    const sendResult = await sendOtp(email, generatedOtp);
    if(sendResult){
      otpSent = true;
      otpExpireTime = Date.now() + 5*60*1000; // expire in 5 minutes
      otpSection.style.display = 'flex';
      otpInput.focus();
    }else{
      otpError.textContent = 'Gagal mengirim OTP, coba lagi.';
      // Re-enable form
      nicknameInput.disabled = false;
      emailInput.disabled = false;
      passwordInput.disabled = false;
      submitBtn.disabled = false;
      otpSent = false;
      generatedOtp = null;
    }
  });

  // Cancel OTP verification
  cancelOtpBtn.addEventListener('click', () => {
    otpSent = false;
    generatedOtp = null;
    otpExpireTime = null;
    otpError.textContent = '';
    otpInput.value = '';
    otpSection.style.display = 'none';
    nicknameInput.disabled = false;
    emailInput.disabled = false;
    passwordInput.disabled = false;
    submitBtn.disabled = false;
  });

  // OTP verification button
  verifyOtpBtn.addEventListener('click', async () => {
    otpError.textContent = '';
    if(!otpSent || !generatedOtp){
      otpError.textContent = 'Silakan kirim OTP terlebih dahulu.';
      return;
    }
    const enteredOtp = otpInput.value.trim();
    if(enteredOtp.length !== 6 || !/^\d{6}$/.test(enteredOtp)){
      otpError.textContent = 'Kode OTP harus 6 digit angka.';
      return;
    }
    if(Date.now() > otpExpireTime){
      otpError.textContent = 'Kode OTP sudah kadaluarsa. Klik batal dan kirim ulang.';
      return;
    }
    if(enteredOtp !== generatedOtp){
      otpError.textContent = 'Kode OTP salah.';
      return;
    }
    // OTP valid - proceed to create Firebase user
    try{
      const nick = nicknameInput.value.trim();
      const email = emailInput.value.trim();
      const pass = passwordInput.value.trim();

      // Check if nickname already exists in DB (prevent duplicates)
      const usersRef = db.ref('users');
      const snapNick = await usersRef.orderByChild('nickname').equalTo(nick).get();
      if(snapNick.exists()){
        otpError.textContent = 'Nickname sudah digunakan. Silakan batal dan gunakan nickname lain.';
        return;
      }
      // Create user in Firebase Authentication
      const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
      const uid = userCredential.user.uid;

      // Save profile info in Realtime Database
      await db.ref('users/' + uid).set({
        nickname: nick,
        email: email,
        bestScore: null
      });

      otpSent = false; // reset OTP state
      generatedOtp = null;
      otpExpireTime = null;

      // Reset form & show home
      form.reset();
      otpSection.style.display = 'none';
      nicknameInput.disabled = false;
      emailInput.disabled = false;
      passwordInput.disabled = false;
      submitBtn.disabled = false;

      await loadUserProfile(uid);
      showSlide(1);

    }catch(err){
      otpError.textContent = 'Gagal membuat akun: '+err.message;
      // Re-enable fields for retry
      nicknameInput.disabled = false;
      emailInput.disabled = false;
      passwordInput.disabled = false;
      submitBtn.disabled = false;
    }
  });

  // Load user profile after login/signup
  async function loadUserProfile(uid){
    try{
      const userRef = db.ref('users/' + uid);
      const snap = await userRef.get();
      if(snap.exists()){
        const data = snap.val();
        dashNickname.textContent = data.nickname || '';
        dashEmail.textContent = data.email || '';
        dashBestScore.textContent = (data.bestScore !== null && data.bestScore !== undefined) ? data.bestScore : 'Belum ada';
        welcomeText.textContent = `Halo, ${data.nickname}! Semangat belajar sains!`;
      }
    }catch(err){
      console.error('Load profile error:', err);
    }
  }

  // Slide 2 buttons
  btnStartQuiz.addEventListener('click', () => {
    startQuiz();
    showSlide(2);
  });
  btnLogout.addEventListener('click', async () => {
    await auth.signOut();
    showSlide(0);
  });

  // Quiz content: questions already known
  const questions = [
    {question: "Apa fungsi dari akar dalam tumbuhan?",answers: [{text: "Membantu proses fotosintesis", correct: false},{text: "Menghisap air dan mineral dari tanah", correct: true},{text: "Mendukung proses respirasi", correct: false},{text: "Tempat penyimpanan hasil fotosintesis", correct: false}]},
    {question: "Dalam sistem tata surya, planet terdekat dari Matahari adalah...",answers: [{text: "Venus", correct: false},{text: "Mars", correct: false},{text: "Merkurius", correct: true},{text: "Bumi", correct: false}]},
    {question: "Suhu pada titik didih air adalah...",answers: [{text: "100 derajat Celsius", correct: true},{text: "0 derajat Celsius", correct: false},{text: "50 derajat Celsius", correct: false},{text: "212 derajat Celsius", correct: false}]},
    {question: "Apa nama zat pembawa informasi genetik pada makhluk hidup?",answers: [{text: "Protein", correct: false},{text: "Karbohidrat", correct: false},{text: "DNA", correct: true},{text: "Lipid", correct: false}]},
    {question: "Hukum Newton yang menyatakan \"Setiap aksi ada reaksi yang sama dan berlawanan arah\" adalah hukum ke-...",answers: [{text: "Pertama", correct: false},{text: "Kedua", correct: false},{text: "Ketiga", correct: true},{text: "Keempat", correct: false}]},
    {question: "Manakah organ tubuh manusia yang berfungsi sebagai tempat pertukaran gas?",answers: [{text: "Jantung", correct: false},{text: "Paru-paru", correct: true},{text: "Hati", correct: false},{text: "Ginjal", correct: false}]},
    {question: "Ciri-ciri makhluk hidup adalah...",answers: [{text: "Melakukan fotosintesis", correct: false},{text: "Bergerak, tumbuh, dan berkembang biak", correct: true},{text: "Memiliki sel", correct: false},{text: "Memerlukan air saja", correct: false}]},
    {question: "Apa perubahan wujud zat dari cair menjadi gas disebut?",answers: [{text: "Menguap (evaporasi)", correct: true},{text: "Mencair", correct: false},{text: "Membeku", correct: false},{text: "Mengembun", correct: false}]},
    {question: "Jenis energi yang berasal dari gerakan benda disebut...",answers: [{text: "Energi potensial", correct: false},{text: "Energi kinetik", correct: true},{text: "Energi panas", correct: false},{text: "Energi cahaya", correct: false}]},
    {question: "Fotosintesis terjadi pada bagian tumbuhan yang disebut...",answers: [{text: "Akar", correct: false},{text: "Bunga", correct: false},{text: "Daun", correct: true},{text: "Batang", correct: false}]},
    // (rest of questions omitted for brevity)
  ];

  let currentQuestionIndex = 0;
  let score = 0;
  let answered = false;

  function startQuiz() {
    currentQuestionIndex = 0;
    score = 0;
    answered = false;
    nextBtn.disabled = true;
    scoreArea.style.display = "none";
    questionNumberElem.style.display = "block";
    questionTextElem.style.display = "block";
    answersElem.style.display = "flex";
    nextBtn.style.display = "inline-block";
    quitBtn.style.display = "inline-block";
    loadQuestion();
  }
  function loadQuestion() {
    answered = false;
    nextBtn.disabled = true;
    resetQuizState();
    let curQ = questions[currentQuestionIndex];
    questionNumberElem.textContent = `Soal ${currentQuestionIndex +1} / ${questions.length}`;
    questionTextElem.textContent = curQ.question;

    curQ.answers.forEach((answer,i) => {
      const btn = document.createElement('button');
      btn.classList.add('answer');
      btn.setAttribute('role','listitem');
      btn.textContent = String.fromCharCode(65 + i) + '. ' + answer.text;
      btn.dataset.correct = answer.correct;
      btn.addEventListener('click', selectAnswer);
      answersElem.appendChild(btn);
    });
  }
  function resetQuizState() {
    while (answersElem.firstChild) answersElem.removeChild(answersElem.firstChild);
  }
  function selectAnswer(e) {
    if (answered) return;
    answered = true;
    const selectedBtn = e.target;
    const correct = selectedBtn.dataset.correct === "true";
    if (correct) {
      selectedBtn.classList.add('correct');
      score++;
    } else {
      selectedBtn.classList.add('incorrect');
    }
    Array.from(answersElem.children).forEach(btn => {
      if (btn.dataset.correct === "true") btn.classList.add('correct');
      btn.disabled = true;
    });
    nextBtn.disabled = false;
  }
  nextBtn.addEventListener('click', () => {
    currentQuestionIndex++;
    if (currentQuestionIndex < questions.length) {
      loadQuestion();
    } else {
      showScore();
    }
  });
  quitBtn.addEventListener('click', () => {
    if(confirm('Apakah Anda yakin ingin keluar dari kuis? Skor tidak akan disimpan.')) {
      showSlide(1);
    }
  });
  restartBtnQuiz.addEventListener('click', () => {
    startQuiz();
  });
  async function showScore() {
    questionNumberElem.style.display = "none";
    questionTextElem.style.display = "none";
    answersElem.style.display = "none";
    nextBtn.style.display = "none";
    quitBtn.style.display = "none";
    scoreArea.style.display = "flex";

    scoreText.textContent = `Kamu menjawab benar ${score} dari ${questions.length} soal. Skor: ${(score / questions.length * 100).toFixed(0)}%`;

    try {
      const user = auth.currentUser;
      if(user){
        const userRef = db.ref('users/' + user.uid);
        const snap = await userRef.get();
        let oldBestScore = null;
        if(snap.exists()) oldBestScore = snap.val().bestScore;
        if(oldBestScore === null || score > oldBestScore){
          await userRef.update({bestScore: score});
          dashBestScore.textContent = score;
        }
      }
      updateLeaderboard();
    }
    catch(err){
      console.error('Gagal update skor:', err);
    }
  }

  async function updateLeaderboard(){
    try{
      const usersRef = db.ref('users');
      const snapshot = await usersRef.orderByChild('bestScore').limitToLast(10).get();
      if(!snapshot.exists()){
        leaderboardList.innerHTML = '<li>Belum ada skor yang tercatat.</li>';
        return;
      }
      let data = [];
      snapshot.forEach(childSnap=>{
        const u = childSnap.val();
        if(u.nickname && u.bestScore !== undefined && u.bestScore !== null){
          data.push({nickname: u.nickname, score: u.bestScore});
        }
      });
      data = data.sort((a,b)=>b.score - a.score);
      leaderboardList.innerHTML = '';
      data.forEach((user, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `<span class="rank">${idx+1}.</span><span>${user.nickname}</span><span>${user.score}</span>`;
        leaderboardList.appendChild(li);
      });
    }catch(err){
      leaderboardList.innerHTML = '<li>Gagal memuat leaderboard.</li>';
      console.error(err);
    }
  }

  // On page load: listen auth state
  auth.onAuthStateChanged(async(user)=>{
    if(user){
      await loadUserProfile(user.uid);
      updateLeaderboard();
      showSlide(1);
    }else{
      showSlide(0);
      resetFormFields();
    }
  });
</script>
</body>
</html>

 
